<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalTip Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0e0e21;
            --sidebar-bg: #111128;
            --card-bg: rgba(255, 255, 255, 0.05);
            --accent: #9f70ff;
            --accent-light: #b48aff;
            --text: #f1f1f9;
            --text-subtle: #b6b6d9;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
            --radius: 16px;
            --error-color: #ff6b6b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            flex-direction: row;
        }

        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 25px 15px;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-header {
            text-align: left;
            margin-bottom: 40px;
        }
        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            margin: 0;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .nav-menu li {
            margin-bottom: 12px;
        }
        .nav-menu a {
            display: block;
            padding: 12px 18px;
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-subtle);
            font-weight: 500;
            transition: all 0.25s;
            cursor: pointer;
        }
        .nav-menu a:hover {
            background: var(--card-bg);
            color: var(--text);
        }
        .nav-menu a.active {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
        }

        .nav-menu .faucet-link {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            text-align: center;
            margin-top: 20px;
            display: block;
            border: 1px solid var(--accent-light);
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .nav-menu .faucet-link:hover {
            background: var(--accent-light);
        }

        .user-section {
            padding: 15px;
            border-top: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-subtle);
        }
        .user-section button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            transition: 0.3s;
        }
        .user-section button:hover {
            background: var(--accent);
            color: #fff;
        }

        .withdraw-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .withdraw-button:hover {
            background-color: var(--accent-light);
        }

        .withdraw-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .menu-button {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 20;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: linear-gradient(160deg, #191932, #0e0e21);
            transition: transform 0.3s ease-in-out;
        }

        h2 {
            margin-top: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-light);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .dashboard-description, .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            font-size: 16px;
            line-height: 1.6;
        }

        .stat-card {
            min-height: 120px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-label {
            font-size: 14px;
            color: var(--text-subtle);
        }

        .withdraw-container {
            margin-top: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }
        input, button.submit-btn {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            margin-bottom: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }
        button.submit-btn {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        button.submit-btn:hover {
            background: var(--accent-light);
        }
        button.submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .history-section-title {
            font-size: 18px;
            color: var(--text);
            margin-top: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 15px;
            overflow-x: auto;
            display: table;
        }

        .history-table thead {
            background: rgba(255, 255, 255, 0.1);
            display: table-header-group;
        }

        .history-table tr {
            display: table-row;
        }
        .history-table tbody tr {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .history-table tbody tr:last-child {
            border-bottom: none;
        }

        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            display: table-cell;
        }

        .history-table thead tr th {
            white-space: nowrap;
        }

        .history-table .explorer-link, .history-table .party-address {
            color: var(--text);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            display: inline-block;
            cursor: pointer;
        }
        .history-table .explorer-link:hover, .history-table .party-address:hover {
            color: var(--accent-light);
            text-decoration: underline;
        }

        .history-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .history-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .transaction-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .transaction-detail-content {
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .transaction-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .transaction-detail-header h3 {
            margin: 0;
            color: var(--accent-light);
            font-size: 20px;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-subtle);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .close-button:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        .transaction-detail-field {
            margin-bottom: 15px;
        }

        .transaction-detail-label {
            font-size: 14px;
            color: var(--text-subtle);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .transaction-detail-value {
            color: var(--text);
            font-size: 16px;
            word-break: break-all;
        }

        .transaction-detail-value.clickable {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        .transaction-detail-value.clickable:hover {
            color: var(--accent-light);
        }

        .description-field {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-subtle);
            font-style: italic;
            min-height: 60px;
        }

        .signature {
            text-align: center;
            margin-top: 30px;
            font-size: 13px;
            color: var(--text-subtle);
        }
        .signature a {
            color: var(--accent);
            text-decoration: none;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .mobile-wallet-container {
            display: none;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        .error-message {
            color: var(--error-color);
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        .dropdown-container {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .dropdown-button {
            width: 100%;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            transition: border-color 0.2s;
            font-size: 15px;
        }

        .dropdown-button:hover {
            border-color: var(--accent);
        }

        .dropdown-icon {
            margin-left: 8px;
            transition: transform 0.2s ease;
        }

        .dropdown-list-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
            z-index: 10;
            display: none;
            padding: 8px 0;
            margin-top: -1px;
            flex-direction: column;
            gap: 4px;
        }

        .dropdown-list-container.open {
            display: flex;
        }

        .dropdown-list-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .dropdown-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dropdown-list-item.selected {
            background-color: var(--accent);
            color: #fff;
        }

        .dropdown-container.open .dropdown-icon {
            transform: rotate(180deg);
        }

        .token-search {
            width: calc(100% - 30px);
            padding: 10px 12px;
            margin: 8px 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        .token-search::placeholder {
            color: var(--text-subtle);
        }

        .token-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-result-item {
            display: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0;
            background-color: rgba(255, 255, 255, 0.1);
            font-size: 15px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }
        .search-result-item.show {
            display: flex;
        }
        .search-result-item span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-result-item .add-btn {
            background: var(--accent);
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .search-result-item .add-btn:hover {
            background: var(--accent-light);
        }
        .add-token-status {
            font-size: 12px;
            color: var(--text-subtle);
            padding-left: 15px;
            margin-top: 5px;
        }

        /* New styles for the claimable tokens section */
        .claimable-tokens-section {
            margin-top: 30px;
        }

        .claimable-tokens-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 15px;
            overflow-x: auto;
            display: table;
        }

        .claimable-tokens-table th, .claimable-tokens-table td {
            padding: 15px;
            text-align: left;
            display: table-cell;
            white-space: nowrap;
        }

        .claimable-tokens-table thead {
            background: rgba(255, 255, 255, 0.1);
            display: table-header-group;
        }
        
        .claimable-tokens-table .withdraw-token-button {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .claimable-tokens-table .withdraw-token-button:hover {
            background: var(--accent-light);
        }
        .claimable-tokens-table .withdraw-token-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 280px;
                transform: translateX(-100%);
                z-index: 100;
            }

            body.menu-open .sidebar {
                transform: translateX(0);
            }
            
            body.menu-open .main-content {
                transform: translateX(280px);
                transition: transform 0.3s ease-in-out;
            }

            .main-content {
                padding: 20px;
                transition: transform 0.3s ease-in-out;
            }
            
            .menu-button {
                display: block;
            }

            .sidebar .user-section {
                display: none;
            }

            .mobile-wallet-container {
                display: flex;
            }
            
            .mobile-wallet-container .wallet-address-display {
                font-size: 14px;
                color: var(--text-subtle);
                margin-right: 10px;
            }
            .mobile-wallet-container .connect-disconnect-btn {
                padding: 8px 12px;
                border-radius: 8px;
                background: var(--card-bg);
                border: 1px solid var(--border);
                color: var(--text);
                cursor: pointer;
                transition: 0.3s;
            }

            .history-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <button class="menu-button" id="menu-button">&#9776; Menu</button>
    <div class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <h2>VitalTip</h2>
                <p style="font-size:12px;color:var(--text-subtle)">Powered by Intuition</p>
            </div>
            <ul class="nav-menu">
                <li><a data-page="dashboard" class="active">Dashboard</a></li>
                <li><a data-page="tip">Send Tip</a></li>
                <li><a data-page="history">History</a></li>
                <li><a href="https://testnet.hub.intuition.systems/" target="_blank" class="faucet-link">Claim Faucet</a></li>
            </ul>
        </div>
        <div class="user-section">
            Connected: <span class="wallet-address-display">Not Connected</span>
            <button class="connect-disconnect-btn">Connect Wallet</button>
        </div>
    </div>

    <div class="main-content">
        <div class="mobile-wallet-container">
            <span class="wallet-address-display">Not Connected</span>
            <button class="connect-disconnect-btn">Connect Wallet</button>
        </div>
        
        <div id="dashboard-page" class="content-section active">
            <h2>Dashboard</h2>
            <div class="dashboard-container">
                <div class="dashboard-description">
                    <p>This decentralized application allows anyone to send small tips to a recipient's wallet address. It's a simple, effective tool to encourage community engagement and reward contributors directly on the blockchain.</p>
                </div>
                <div class="stat-card">
                    <div id="total-received" class="stat-value">0.00</div>
                    <div class="stat-label">Total Tips Received (tTRUST)</div>
                </div>
                <div class="stat-card">
                    <div id="tips-received-count-card" class="stat-value">0</div>
                    <div class="stat-label">Tips Received (Count)</div>
                </div>
                <div class="stat-card">
                    <div id="total-sent" class="stat-value">0</div>
                    <div class="stat-label">Total Tips Sent</div>
                </div>
            </div>

            <div class="claimable-tokens-section">
                <h3>Claimable Tipped Tokens</h3>
                <div id="claimable-status" style="font-size: 14px; margin-bottom: 10px;">Connect your wallet to see claimable tokens.</div>
                <table class="claimable-tokens-table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="claimable-tokens-table-body">
                        <!-- Dynamically populated rows will go here -->
                    </tbody>
                </table>
            </div>

            <div class="withdraw-container">
                <div id="dashboard-status" style="margin-top: 15px; font-size: 14px;"></div>
            </div>
        </div>

        <div id="tip-page" class="content-section">
            <h2>Send a Tip</h2>
            <div class="form-group">
                <input type="text" id="recipientAddress" placeholder="Recipient's wallet address" />
                
                <div class="dropdown-container" id="token-dropdown">
                    <button class="dropdown-button" id="dropdown-button">
                        <span id="selected-token-display">tTRUST (Native)</span>
                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="dropdown-list-container" id="token-list-container">
                        <input type="text" id="token-search" class="token-search" placeholder="Search tokens or paste contract address...">
                        <div id="search-result-item" class="search-result-item">
                            <span id="search-result-name"></span>
                            <button class="add-btn">Add</button>
                        </div>
                        <div class="dropdown-list" id="token-list">
                            <div class="dropdown-list-item selected" data-value="0x0000000000000000000000000000000000000000" data-name="tTRUST">tTRUST (Native)</div>
                        </div>
                    </div>
                </div>

                <input type="number" id="tipAmount" placeholder="Amount to tip" min="0.001" step="0.001" />
                
                <textarea 
                    id="tipDescription" 
                    placeholder="Optional: Add a description for this tip"
                    rows="3"
                    style="width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 15px; margin-bottom: 15px; font-family: inherit; resize: vertical;"
                ></textarea>
                
                <button id="tipButton" class="submit-btn" disabled>Send Tip</button>
                <div id="status"></div>
                <div id="self-tip-message" class="error-message" style="display:none;"></div>
            </div>
        </div>

        <div id="history-page" class="content-section">
            <h2>All Transactions</h2>
            
            <div id="all-history-status" style="font-size: 14px; margin-bottom: 10px;">Connect your wallet to see history.</div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Party</th>
                        <th>Tx Hash</th>
                    </tr>
                </thead>
                <tbody id="all-history-table-body"></tbody>
            </table>
        </div>

        <div class="signature">
            Made with ♥ by <a href="https://x.com/Jrken_ny" target="_blank">Jrkenny</a>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transaction-detail-modal" class="transaction-detail-modal" style="display: none;">
        <div class="transaction-detail-content">
            <div class="transaction-detail-header">
                <h3>Transaction Details</h3>
                <button class="close-button" id="close-modal">×</button>
            </div>
            
            <div class="transaction-detail-field">
                <div class="transaction-detail-label">Time and Date</div>
                <div class="transaction-detail-value" id="modal-date"></div>
            </div>
            
            <div class="transaction-detail-field">
                <div class="transaction-detail-label">Transaction ID</div>
                <div class="transaction-detail-value clickable" id="modal-tx-hash"></div>
            </div>
            
            <div class="transaction-detail-field">
                <div class="transaction-detail-label">Type</div>
                <div class="transaction-detail-value" id="modal-type"></div>
            </div>
            
            <div class="transaction-detail-field">
                <div class="transaction-detail-label">Amount</div>
                <div class="transaction-detail-value" id="modal-amount"></div>
            </div>
            
            <div class="transaction-detail-field" id="modal-party-field">
                <div class="transaction-detail-label" id="modal-party-label">Party</div>
                <div class="transaction-detail-value clickable" id="modal-party"></div>
            </div>
            
            <div class="transaction-detail-field" id="modal-description-field">
                <div class="transaction-detail-label" id="modal-description-label">Description</div>
                <div class="description-field" id="modal-description"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Smart Contract details
            const contractAddress = "0x880931ff3977deb7773bbc1f777c9e22d4df399e";
            const contractABI = [
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_recipient",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "_description",
                            "type": "string"
                        }
                    ],
                    "name": "sendTip",
                    "outputs": [],
                    "stateMutability": "payable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        }
                    ],
                    "name": "withdrawTips",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "tipper",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "recipient",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "amount",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "description",
                            "type": "string"
                        }
                    ],
                    "name": "TipSent",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "recipient",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "amount",
                            "type": "uint256"
                        }
                    ],
                    "name": "TipsWithdrawn",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "balances",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_recipient",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        }
                    ],
                    "name": "getTippableBalance",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            const ERC20_ABI = [
                "function approve(address spender, uint256 amount) returns (bool)",
                "function decimals() view returns (uint8)",
                "function symbol() view returns (string)",
                "function name() view returns (string)",
                "function transfer(address to, uint256 amount) returns (bool)",
                "function balanceOf(address account) view returns (uint256)",
                "function allowance(address owner, address spender) view returns (uint256)"
            ];
            // Ethers.js provider and signer variables
            let provider;
            let signer;
            let tipJarContract;
            let userAddress = null;

            // Network details for Intuition Testnet
            const INTUITION_NETWORK_DETAILS = {
                chainId: "0x350B", // Hexadecimal for 13579
                chainName: "Intuition Testnet",
                nativeCurrency: {
                    name: "tTRUST",
                    symbol: "tTRUST",
                    decimals: 18
                },
                rpcUrls: ["https://testnet.rpc.intuition.systems/http"],
                blockExplorerUrls: ["https://testnet.explorer.intuition.systems"]
            };
            // DOM element references
            const recipientInput = document.getElementById("recipientAddress");
            const amountInput = document.getElementById("tipAmount");
            const descriptionInput = document.getElementById("tipDescription");
            const tipButton = document.getElementById("tipButton");
            const statusDiv = document.getElementById("status");
            const selfTipMessage = document.getElementById("self-tip-message");
            const dashboardStatusDiv = document.getElementById("dashboard-status");
            
            const allHistoryTableBody = document.getElementById("all-history-table-body");
            const allHistoryStatus = document.getElementById("all-history-status");

            const totalReceivedDisplay = document.getElementById("total-received");
            const tipsReceivedCountDisplay = document.getElementById("tips-received-count-card");
            const totalSentDisplay = document.getElementById("total-sent");
            const claimableTokensTableBody = document.getElementById("claimable-tokens-table-body");
            const claimableStatusDiv = document.getElementById("claimable-status");

            const navLinks = document.querySelectorAll(".nav-menu a[data-page]");
            const contentSections = document.querySelectorAll(".content-section");
            const menuButton = document.getElementById("menu-button");
            const sidebar = document.getElementById("sidebar");

            const body = document.body;
            const walletDisplays = document.querySelectorAll(".wallet-address-display");
            const connectDisconnectBtns = document.querySelectorAll(".connect-disconnect-btn");
            
            // New dropdown DOM elements
            const tokenDropdown = document.getElementById("token-dropdown");
            const dropdownButton = document.getElementById("dropdown-button");
            const tokenListContainer = document.getElementById("token-list-container");
            const tokenList = document.getElementById("token-list");
            const tokenSearch = document.getElementById("token-search");
            const selectedTokenDisplay = document.getElementById("selected-token-display");

            // Elements for dynamic search result
            const searchResultItem = document.getElementById("search-result-item");
            const searchResultName = document.getElementById("search-result-name");
            const addTokenButton = searchResultItem.querySelector('.add-btn');

            // Modal elements
            const transactionModal = document.getElementById("transaction-detail-modal");
            const closeModalButton = document.getElementById("close-modal");
            const modalDate = document.getElementById("modal-date");
            const modalTxHash = document.getElementById("modal-tx-hash");
            const modalType = document.getElementById("modal-type");
            const modalAmount = document.getElementById("modal-amount");
            const modalPartyField = document.getElementById("modal-party-field");
            const modalPartyLabel = document.getElementById("modal-party-label");
            const modalParty = document.getElementById("modal-party");
            const modalDescriptionField = document.getElementById("modal-description-field");
            const modalDescriptionLabel = document.getElementById("modal-description-label");
            const modalDescription = document.getElementById("modal-description");
            
            let selectedTokenAddress = "0x0000000000000000000000000000000000000000";
            const CUSTOM_TOKENS_STORAGE_KEY = 'customTokens';
            const PAGE_STORAGE_KEY = 'lastPage';

            // A central array to keep track of tokens, including the native one
            let allAvailableTokens = [{ address: "0x0000000000000000000000000000000000000000", symbol: "tTRUST", native: true }];
            
            // Store for all transactions with descriptions
            let allTransactions = [];

            // --- UI Logic ---
            // Function to handle page navigation
            function showPage(pageId) {
                localStorage.setItem(PAGE_STORAGE_KEY, pageId);
                contentSections.forEach(s => s.classList.remove("active"));
                document.getElementById(pageId).classList.add("active");
                navLinks.forEach(l => l.classList.remove("active"));
                const activeLink = document.querySelector(`.nav-menu a[data-page="${pageId.replace('-page', '')}"]`);
                if (activeLink) {
                    activeLink.classList.add("active");
                }
                if (window.innerWidth <= 768) {
                    body.classList.remove("menu-open");
                }
            }

            // Event listener for mobile menu button
            menuButton.addEventListener("click", () => {
                body.classList.toggle("menu-open");
            });

            // Event listeners for navigation links
            navLinks.forEach(link => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    showPage(`${page}-page`);
                });
            });

            // Event listeners for connect/disconnect buttons
            connectDisconnectBtns.forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (userAddress) {
                        disconnectWallet();
                    } else {
                        connectWallet();
                    }
                };
            });

            // Modal event listeners
            closeModalButton.addEventListener("click", () => {
                transactionModal.style.display = "none";
            });
            transactionModal.addEventListener("click", (e) => {
                if (e.target === transactionModal) {
                    transactionModal.style.display = "none";
                }
            });

            // Dropdown & Token Logic
            const loadCustomTokens = () => {
                const storedTokens = JSON.parse(localStorage.getItem(CUSTOM_TOKENS_STORAGE_KEY) || '[]');
                allAvailableTokens = [...allAvailableTokens.filter(t => t.native), ...storedTokens];
                renderTokenList();
            };
            const saveCustomTokens = (tokens) => {
                localStorage.setItem(CUSTOM_TOKENS_STORAGE_KEY, JSON.stringify(tokens));
            };
            const renderTokenList = () => {
                tokenList.innerHTML = "";
                allAvailableTokens.forEach(token => {
                    const newListItem = document.createElement("div");
                    newListItem.classList.add("dropdown-list-item");
                    newListItem.setAttribute("data-value", token.address);
                    newListItem.setAttribute("data-name", token.symbol);
                    newListItem.textContent = token.symbol + (token.native ? ' (Native)' : '');
                    tokenList.appendChild(newListItem);
                });
            };

            dropdownButton.addEventListener("click", (e) => {
                e.stopPropagation();
                tokenListContainer.classList.toggle("open");
                if (tokenListContainer.classList.contains("open")) {
                    tokenSearch.focus();
                }
            });

            // Search functionality
            tokenSearch.addEventListener("input", async (e) => {
                const searchValue = e.target.value.trim();
                const listItems = tokenList.querySelectorAll(".dropdown-list-item");
                searchResultItem.classList.remove('show');
                listItems.forEach(item => {
                    const text = item.getAttribute('data-name').toLowerCase();
                    if (text.includes(searchValue.toLowerCase())) {
                        item.style.display = "flex";
                    } else {
                        item.style.display = "none";
                    }
                });
                if (ethers.utils.isAddress(searchValue)) {
                    const existingItem = allAvailableTokens.some(t => t.address.toLowerCase() === searchValue.toLowerCase());
                    if (existingItem) {
                        return;
                    }
                    try {
                        const tokenContract = new ethers.Contract(searchValue, ERC20_ABI, provider);
                        const tokenSymbol = await tokenContract.symbol();
                        searchResultName.textContent = tokenSymbol;
                        searchResultItem.classList.add('show');
                        addTokenButton.setAttribute('data-address', searchValue);
                        addTokenButton.setAttribute('data-symbol', tokenSymbol);
                    } catch (error) {
                        console.error("Error fetching token:", error);
                        searchResultItem.classList.remove('show');
                    }
                }
            });

            // Handle token selection from the main list
            tokenList.addEventListener("click", (e) => {
                const clickedItem = e.target.closest(".dropdown-list-item");
                if (clickedItem) {
                    const address = clickedItem.getAttribute("data-value");
                    const name = clickedItem.getAttribute("data-name");
                    selectToken(address, name);
                }
            });

            const selectToken = (address, name) => {
                selectedTokenAddress = address;
                selectedTokenDisplay.textContent = name + (address === "0x0000000000000000000000000000000000000000" ? ' (Native)' : '');
                const allItems = tokenList.querySelectorAll(".dropdown-list-item");
                allItems.forEach(item => item.classList.remove("selected"));
                const selectedItem = tokenList.querySelector(`[data-value="${address.toLowerCase()}"]`);
                if (selectedItem) {
                    selectedItem.classList.add("selected");
                }
                tokenListContainer.classList.remove("open");
            };

            // Handle clicking the "Add" button on the search result
            addTokenButton.addEventListener("click", (e) => {
                e.stopPropagation();
                const tokenAddress = addTokenButton.getAttribute('data-address');
                const tokenSymbol = addTokenButton.getAttribute('data-symbol');
                const storedTokens = JSON.parse(localStorage.getItem(CUSTOM_TOKENS_STORAGE_KEY) || '[]');
                const isNew = !storedTokens.some(t => t.address.toLowerCase() === tokenAddress.toLowerCase());
                if (isNew) {
                    storedTokens.push({ address: tokenAddress, symbol: tokenSymbol });
                    saveCustomTokens(storedTokens);
                }
                loadCustomTokens();
                selectToken(tokenAddress, tokenSymbol);
                searchResultItem.classList.remove('show');
                tokenSearch.value = "";
            });

            document.addEventListener("click", (e) => {
                if (!tokenDropdown.contains(e.target) && !menuButton.contains(e.target)) {
                    tokenListContainer.classList.remove("open");
                }
            });

            // --- Wallet and Ethers.js Logic ---
            function initializeContract() {
                if (typeof window.ethereum === 'undefined') {
                    walletDisplays.forEach(el => el.innerText = "MetaMask not found.");
                    return false;
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                tipJarContract = new ethers.Contract(contractAddress, contractABI, signer);
                return true;
            }

            async function checkIfWalletIsConnected() {
                if (typeof window.ethereum !== 'undefined' && window.ethereum.isConnected()) {
                    try {
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            userAddress = accounts[0];
                            walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                            connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                            fetchDataAndHistory();
                        } else {
                            userAddress = null;
                            walletDisplays.forEach(el => el.innerText = "Not Connected");
                            connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                            clearDashboardData();
                            clearHistory();
                        }
                    } catch (error) {
                        console.error("Error checking for connected wallet:", error);
                        userAddress = null;
                        walletDisplays.forEach(el => el.innerText = "Not Connected");
                        connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                        clearDashboardData();
                        clearHistory();
                    }
                } else {
                    userAddress = null;
                    walletDisplays.forEach(el => el.innerText = "Not Connected");
                    connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                    clearDashboardData();
                    clearHistory();
                }
            }

            async function connectWallet() {
                try {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== INTUITION_NETWORK_DETAILS.chainId) {
                        try {
                            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: INTUITION_NETWORK_DETAILS.chainId }], });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [INTUITION_NETWORK_DETAILS], });
                                } catch (addError) {
                                    statusDiv.textContent = "Failed to add the network. Please add it manually.";
                                    return;
                                }
                            }
                        }
                    }
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                    connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                    fetchDataAndHistory();
                } catch (error) {
                    console.error("User denied account access or other error:", error);
                    statusDiv.textContent = "Connection failed. Please try again.";
                }
            }

            async function disconnectWallet() {
                userAddress = null;
                walletDisplays.forEach(el => el.innerText = "Not Connected");
                connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                clearDashboardData();
                clearHistory();
            }

            async function fetchDataAndHistory() {
                if (!userAddress || !tipJarContract) {
                    clearDashboardData();
                    clearHistory();
                    return;
                }
                
                // Fetch claimable balances
                await fetchClaimableBalances();

                // Fetch tips counts
                let tipsReceivedCount = 0;
                let totalSentCount = 0;
                try {
                    const tipSentFilter = tipJarContract.filters.TipSent();
                    const logs = await provider.getLogs({
                        address: tipJarContract.address,
                        topics: tipSentFilter.topics,
                        fromBlock: 0
                    });
                    for (const log of logs) {
                        const parsedLog = tipJarContract.interface.parseLog(log);
                        if (parsedLog.args.recipient.toLowerCase() === userAddress.toLowerCase()) {
                            tipsReceivedCount++;
                        }
                        if (parsedLog.args.tipper.toLowerCase() === userAddress.toLowerCase()) {
                            totalSentCount++;
                        }
                    }
                    tipsReceivedCountDisplay.textContent = tipsReceivedCount;
                    totalSentDisplay.textContent = totalSentCount;
                } catch (error) {
                    console.error("Error fetching tips counts:", error);
                }

                await fetchAllHistory();
            }

            async function fetchClaimableBalances() {
                claimableStatusDiv.textContent = "Loading claimable balances...";
                claimableTokensTableBody.innerHTML = "";
                let hasClaimableTokens = false;
                
                try {
                    const nativeTokenBalance = await tipJarContract.getTippableBalance(userAddress, "0x0000000000000000000000000000000000000000");
                    const formattedNativeBalance = ethers.utils.formatEther(nativeTokenBalance);
                    totalReceivedDisplay.textContent = parseFloat(formattedNativeBalance).toFixed(2);
                    
                    if (nativeTokenBalance.gt(0)) {
                        hasClaimableTokens = true;
                        addTokenRow("tTRUST", "0x0000000000000000000000000000000000000000", formattedNativeBalance);
                    }

                    // Check for other tokens from the local storage list
                    for (const token of allAvailableTokens.filter(t => !t.native)) {
                        const tokenContract = new ethers.Contract(token.address, ERC20_ABI, provider);
                        const tokenDecimals = await tokenContract.decimals();
                        const tokenBalance = await tipJarContract.getTippableBalance(userAddress, token.address);
                        
                        if (tokenBalance.gt(0)) {
                            hasClaimableTokens = true;
                            const formattedTokenBalance = ethers.utils.formatUnits(tokenBalance, tokenDecimals);
                            addTokenRow(token.symbol, token.address, formattedTokenBalance);
                        }
                    }

                    if (hasClaimableTokens) {
                        claimableStatusDiv.textContent = "";
                    } else {
                        claimableStatusDiv.textContent = "You have no claimable tokens yet.";
                    }
                } catch (error) {
                    console.error("Error fetching claimable balances:", error);
                    claimableStatusDiv.textContent = "Failed to load claimable balances. Please try again.";
                }
            }

            function addTokenRow(symbol, address, amount) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${symbol}</td>
                    <td>${parseFloat(amount).toFixed(2)}</td>
                    <td><button class="withdraw-token-button" data-token-address="${address}" data-token-symbol="${symbol}">Withdraw</button></td>
                `;
                claimableTokensTableBody.appendChild(row);
                
                const withdrawButton = row.querySelector('.withdraw-token-button');
                withdrawButton.addEventListener('click', () => handleWithdrawal(address, symbol));
            }

            async function handleWithdrawal(tokenAddress, tokenSymbol) {
                dashboardStatusDiv.textContent = `Preparing to withdraw ${tokenSymbol}...`;
                try {
                    const tx = await tipJarContract.withdrawTips(tokenAddress);
                    dashboardStatusDiv.textContent = `Withdrawal transaction submitted. Waiting for confirmation... Tx Hash: ${tx.hash}`;
                    const receipt = await tx.wait();
                    dashboardStatusDiv.textContent = `Withdrawal successful! Tx Hash: ${receipt.transactionHash}`;
                    // Re-fetch balances after successful withdrawal
                    fetchClaimableBalances();
                } catch (error) {
                    console.error("Withdrawal failed:", error);
                    dashboardStatusDiv.textContent = `Withdrawal failed: ${error.message}`;
                }
            }

            async function fetchAllHistory() {
                allHistoryStatus.textContent = "Fetching all transactions...";
                allHistoryTableBody.innerHTML = "";
                allTransactions = [];

                const userLower = userAddress.toLowerCase();

                const tipSentFilter = tipJarContract.filters.TipSent();
                const tipsWithdrawnFilter = tipJarContract.filters.TipsWithdrawn();

                try {
                    const tipLogs = await provider.getLogs({
                        address: tipJarContract.address,
                        topics: tipSentFilter.topics,
                        fromBlock: 0
                    });

                    for (const log of tipLogs) {
                        const parsedLog = tipJarContract.interface.parseLog(log);
                        const isSent = parsedLog.args.tipper.toLowerCase() === userLower;
                        const isReceived = parsedLog.args.recipient.toLowerCase() === userLower;
                        
                        if (isSent || isReceived) {
                            const transaction = {
                                type: isSent ? "Sent" : "Received",
                                amount: ethers.utils.formatEther(parsedLog.args.amount),
                                party: isSent ? parsedLog.args.recipient : parsedLog.args.tipper,
                                txHash: log.transactionHash,
                                blockNumber: log.blockNumber,
                                token: parsedLog.args.token,
                                description: parsedLog.args.description,
                                from: parsedLog.args.tipper,
                                to: parsedLog.args.recipient
                            };
                            allTransactions.push(transaction);
                        }
                    }

                    const withdrawLogs = await provider.getLogs({
                        address: tipJarContract.address,
                        topics: tipsWithdrawnFilter.topics,
                        fromBlock: 0
                    });

                    for (const log of withdrawLogs) {
                        const parsedLog = tipJarContract.interface.parseLog(log);
                        if (parsedLog.args.recipient.toLowerCase() === userLower) {
                            const transaction = {
                                type: "Withdrawal",
                                amount: ethers.utils.formatEther(parsedLog.args.amount),
                                party: "Self",
                                txHash: log.transactionHash,
                                blockNumber: log.blockNumber,
                                token: parsedLog.args.token,
                                description: "Tips withdrawal."
                            };
                            allTransactions.push(transaction);
                        }
                    }

                    // Sort transactions by block number descending
                    allTransactions.sort((a, b) => b.blockNumber - a.blockNumber);

                    renderHistoryTable();

                    if (allTransactions.length === 0) {
                        allHistoryStatus.textContent = "No transactions found.";
                    } else {
                        allHistoryStatus.textContent = "";
                    }

                } catch (error) {
                    console.error("Error fetching history:", error);
                    allHistoryStatus.textContent = "Failed to fetch history. Please try again.";
                }
            }

            function renderHistoryTable() {
                allHistoryTableBody.innerHTML = "";
                allTransactions.forEach(tx => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${tx.type}</td>
                        <td>${parseFloat(tx.amount).toFixed(2)}</td>
                        <td>
                            <div class="party-address" data-address="${tx.party}">
                                ${tx.party === "Self" ? "Self" : tx.party.substring(0, 6) + "..." + tx.party.substring(38)}
                            </div>
                        </td>
                        <td>
                            <a href="${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/tx/${tx.txHash}" target="_blank" class="explorer-link">
                                ${tx.txHash.substring(0, 6) + "..." + tx.txHash.substring(62)}
                            </a>
                        </td>
                    `;
                    row.addEventListener('click', () => showTransactionDetails(tx));
                    allHistoryTableBody.appendChild(row);
                });
            }
            
            async function showTransactionDetails(tx) {
                const timestamp = await getTransactionTimestamp(tx.txHash);
                modalDate.textContent = timestamp ? new Date(timestamp * 1000).toLocaleString() : 'N/A';
                modalTxHash.textContent = tx.txHash;
                modalTxHash.onclick = () => window.open(`${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/tx/${tx.txHash}`, '_blank');
                modalType.textContent = tx.type;
                
                let tokenInfo = allAvailableTokens.find(t => t.address.toLowerCase() === tx.token.toLowerCase());
                if (!tokenInfo) {
                    try {
                        const tokenContract = new ethers.Contract(tx.token, ERC20_ABI, provider);
                        tokenInfo = {
                            symbol: await tokenContract.symbol(),
                            decimals: await tokenContract.decimals()
                        };
                    } catch {
                        tokenInfo = { symbol: "Unknown", decimals: 18 };
                    }
                }
                const amountWithDecimals = tokenInfo.decimals ? ethers.utils.formatUnits(tx.amount, tokenInfo.decimals) : ethers.utils.formatEther(tx.amount);
                
                modalAmount.textContent = `${parseFloat(amountWithDecimals).toFixed(2)} ${tokenInfo.symbol}`;
                
                if (tx.party && tx.party !== "Self") {
                    modalPartyField.style.display = "block";
                    modalPartyLabel.textContent = tx.type === "Sent" ? "Recipient Address" : "Tipper Address";
                    modalParty.textContent = tx.party;
                    modalParty.onclick = () => window.open(`${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/address/${tx.party}`, '_blank');
                } else {
                    modalPartyField.style.display = "none";
                }
                
                if (tx.description && tx.description.trim() !== "") {
                    modalDescriptionField.style.display = "block";
                    modalDescription.textContent = tx.description;
                } else {
                    modalDescriptionField.style.display = "none";
                }
                
                transactionModal.style.display = "flex";
            }
            
            async function getTransactionTimestamp(txHash) {
                try {
                    const tx = await provider.getTransaction(txHash);
                    if (tx) {
                        const block = await provider.getBlock(tx.blockNumber);
                        return block.timestamp;
                    }
                } catch (error) {
                    console.error("Error fetching transaction timestamp:", error);
                }
                return null;
            }

            function clearDashboardData() {
                totalReceivedDisplay.textContent = "0.00";
                tipsReceivedCountDisplay.textContent = "0";
                totalSentDisplay.textContent = "0";
                dashboardStatusDiv.textContent = "";
                claimableTokensTableBody.innerHTML = "";
                claimableStatusDiv.textContent = "Connect your wallet to see claimable tokens.";
            }

            function clearHistory() {
                allHistoryTableBody.innerHTML = "";
                allHistoryStatus.textContent = "Connect your wallet to see history.";
                allTransactions = [];
            }
            
            // --- Tip Logic ---
            async function validateInput() {
                const recipient = recipientInput.value.trim();
                const amount = amountInput.value.trim();
                const isRecipientValid = ethers.utils.isAddress(recipient);
                const isAmountValid = !isNaN(parseFloat(amount)) && parseFloat(amount) > 0;
                
                const isSelfTip = isRecipientValid && userAddress && recipient.toLowerCase() === userAddress.toLowerCase();
                selfTipMessage.style.display = isSelfTip ? "block" : "none";

                tipButton.disabled = !(isRecipientValid && isAmountValid && !isSelfTip);
            }
            
            recipientInput.addEventListener('input', validateInput);
            amountInput.addEventListener('input', validateInput);
            
            tipButton.addEventListener('click', async () => {
                if (!userAddress) {
                    statusDiv.textContent = "Please connect your wallet first.";
                    return;
                }

                const recipient = recipientInput.value.trim();
                const amount = amountInput.value.trim();
                const description = descriptionInput.value.trim() || "No description provided.";
                
                statusDiv.textContent = "Preparing transaction...";
                tipButton.disabled = true;

                try {
                    const parsedAmount = ethers.utils.parseEther(amount);
                    
                    if (selectedTokenAddress === "0x0000000000000000000000000000000000000000") {
                        // Native token (tTRUST)
                        const tx = await tipJarContract.sendTip(recipient, selectedTokenAddress, description, { value: parsedAmount });
                        statusDiv.textContent = `Transaction submitted. Waiting for confirmation... Tx Hash: ${tx.hash}`;
                        const receipt = await tx.wait();
                        statusDiv.textContent = `Tip sent successfully! Tx Hash: ${receipt.transactionHash}`;
                    } else {
                        // ERC20 token
                        const tokenContract = new ethers.Contract(selectedTokenAddress, ERC20_ABI, signer);
                        const allowance = await tokenContract.allowance(userAddress, contractAddress);
                        
                        if (allowance.lt(parsedAmount)) {
                            statusDiv.textContent = "Approving tokens...";
                            const approveTx = await tokenContract.approve(contractAddress, parsedAmount);
                            await approveTx.wait();
                            statusDiv.textContent = "Approval successful. Sending tip...";
                        }
                        
                        const tx = await tipJarContract.sendTip(recipient, selectedTokenAddress, description);
                        statusDiv.textContent = `Transaction submitted. Waiting for confirmation... Tx Hash: ${tx.hash}`;
                        const receipt = await tx.wait();
                        statusDiv.textContent = `Tip sent successfully! Tx Hash: ${receipt.transactionHash}`;
                    }
                } catch (error) {
                    console.error(error);
                    statusDiv.textContent = `Transaction failed: ${error.message}`;
                } finally {
                    tipButton.disabled = false;
                }
            });


            // --- Initialization ---
            const lastPage = localStorage.getItem(PAGE_STORAGE_KEY);
            if (lastPage) {
                showPage(lastPage);
            } else {
                showPage('dashboard-page');
            }

            if (initializeContract()) {
                checkIfWalletIsConnected();
                loadCustomTokens();
            }

            // Listen for Metamask account/chain changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                        connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                        fetchDataAndHistory();
                    } else {
                        disconnectWallet();
                    }
                });

                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
            }
        });
    </script>
</body>
</html>
