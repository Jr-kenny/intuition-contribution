<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalTip Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --bg-dark: #0e0e21;
            --sidebar-bg: #111128;
            --card-bg: rgba(255, 255, 255, 0.05);
            --accent: #9f70ff;
            --accent-light: #b48aff;
            --text: #f1f1f9;
            --text-subtle: #b6b6d9;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
            --radius: 16px;
            --error-color: #ff6b6b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            flex-direction: row; /* Default for desktop */
        }
        
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 25px 15px;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-header {
            text-align: left;
            margin-bottom: 40px;
        }
        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            margin: 0;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .nav-menu li {
            margin-bottom: 12px;
        }
        .nav-menu a {
            display: block;
            padding: 12px 18px;
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-subtle);
            font-weight: 500;
            transition: all 0.25s;
        }
        .nav-menu a:hover {
            background: var(--card-bg);
            color: var(--text);
        }
        .nav-menu a.active {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
        }
        
        .nav-menu .faucet-link {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            text-align: center;
            margin-top: 20px;
            display: block;
            border: 1px solid var(--accent-light);
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .nav-menu .faucet-link:hover {
            background: var(--accent-light);
        }

        .user-section {
            padding: 15px;
            border-top: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-subtle);
        }
        .user-section button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            transition: 0.3s;
        }
        .user-section button:hover {
            background: var(--accent);
            color: #fff;
        }
        
        .withdraw-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .withdraw-button:hover {
            background-color: var(--accent-light);
        }
        
        .menu-button {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 20;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: linear-gradient(160deg, #191932, #0e0e21);
            transition: transform 0.3s ease-in-out;
        }

        h2 {
            margin-top: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-light);
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .dashboard-description, .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            font-size: 16px;
            line-height: 1.6;
        }
        
        .stat-card {
            min-height: 120px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-label {
            font-size: 14px;
            color: var(--text-subtle);
        }
        
        .withdraw-container {
            margin-top: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }
        input, textarea, button.submit-btn {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            margin-bottom: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            padding: 14px;
        }
        button.submit-btn {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        button.submit-btn:hover {
            background: var(--accent-light);
        }
        
        .history-section-title {
            font-size: 18px;
            color: var(--text);
            margin-top: 20px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-top: 15px;
            overflow-x: auto;
            display: table;
        }
        
        .history-table thead {
            background: rgba(255, 255, 255, 0.1);
            display: table-header-group;
        }
        
        .history-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .history-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .history-table tr {
            display: table-row;
        }
        .history-table tbody tr {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .history-table tbody tr:last-child {
            border-bottom: none;
        }

        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            display: table-cell;
        }
        
        .history-table thead tr th {
            white-space: nowrap;
        }
        
        .history-table td.description-cell {
            white-space: normal;
            word-break: break-word;
            max-width: 250px;
        }

        .history-table .explorer-link, .history-table .party-address {
            color: var(--text);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            display: inline-block;
            cursor: pointer;
        }
        .history-table .explorer-link:hover, .history-table .party-address:hover {
            color: var(--accent-light);
            text-decoration: underline;
        }

        .signature {
            text-align: center;
            margin-top: 30px;
            font-size: 13px;
            color: var(--text-subtle);
        }
        .signature a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }
        
        .mobile-wallet-container {
            display: none;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .error-message {
            color: var(--error-color);
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        /* Styles for the new dropdown and custom token input */
        .dropdown-container {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .dropdown-button {
            width: 100%;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            transition: border-color 0.2s;
            font-size: 15px;
        }

        .dropdown-button:hover {
            border-color: var(--accent);
        }

        .dropdown-icon {
            margin-left: 8px;
            transition: transform 0.2s ease;
        }

        .dropdown-list-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: var(--sidebar-bg);
            border: 1px solid var(--border);
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
            z-index: 10;
            display: none;
            padding: 8px 0;
            margin-top: -1px;
            flex-direction: column;
            gap: 4px;
        }

        .dropdown-list-container.open {
            display: flex;
        }

        .dropdown-list-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .dropdown-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dropdown-list-item.selected {
            background-color: var(--accent);
            color: #fff;
        }
        
        .dropdown-container.open .dropdown-icon {
            transform: rotate(180deg);
        }
        
        .token-search {
            width: calc(100% - 30px);
            padding: 10px 12px;
            margin: 8px 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        .token-search::placeholder {
            color: var(--text-subtle);
        }

        .token-search:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search-result-item {
            display: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 0;
            background-color: rgba(255, 255, 255, 0.1);
            font-size: 15px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }
        .search-result-item.show {
            display: flex;
        }
        .search-result-item span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-result-item .add-btn {
            background: var(--accent);
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .search-result-item .add-btn:hover {
            background: var(--accent-light);
        }
        .add-token-status {
            font-size: 12px;
            color: var(--text-subtle);
            padding-left: 15px;
            margin-top: 5px;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal.is-visible {
            display: flex;
        }

        .modal-content {
            background-color: var(--sidebar-bg);
            padding: 30px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content .close-btn {
            color: var(--text-subtle);
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-content .close-btn:hover {
            color: var(--accent);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-light);
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-body p {
            margin: 10px 0;
            font-size: 16px;
        }
        .modal-body strong {
            color: var(--text);
            font-weight: 600;
            margin-right: 10px;
        }
        .modal-body .full-address {
            word-break: break-all;
            font-size: 14px;
            color: var(--text-subtle);
        }
        .modal-body a {
            color: var(--accent);
            text-decoration: none;
            word-break: break-all;
        }
        .modal-body a:hover {
            text-decoration: underline;
        }


        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 280px;
                transform: translateX(-100%);
                z-index: 100;
            }

            body.menu-open .sidebar {
                transform: translateX(0);
            }
            
            body.menu-open .main-content {
                transform: translateX(280px);
                transition: transform 0.3s ease-in-out;
            }

            .main-content {
                padding: 20px;
                transition: transform 0.3s ease-in-out;
            }
            
            .menu-button {
                display: block;
            }

            .sidebar .user-section {
                display: none;
            }

            .mobile-wallet-container {
                display: flex;
            }
            
            .mobile-wallet-container .wallet-address-display {
                font-size: 14px;
                color: var(--text-subtle);
                margin-right: 10px;
            }
            .mobile-wallet-container .connect-disconnect-btn {
                padding: 8px 12px;
                border-radius: 8px;
                background: var(--card-bg);
                border: 1px solid var(--border);
                color: var(--text);
                cursor: pointer;
                transition: 0.3s;
            }

            .history-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <button class="menu-button" id="menu-button">&#9776; Menu</button>
    <div class="sidebar" id="sidebar">
        <div>
            <div class="sidebar-header">
                <h2>VitalTip</h2>
                <p style="font-size:12px;color:var(--text-subtle)">Powered by Intuition</p>
            </div>
            <ul class="nav-menu">
                <!-- Data attributes for navigation pages -->
                <li><a data-page="dashboard" class="active">Dashboard</a></li>
                <li><a data-page="tip">Send Tip</a></li>
                <li><a data-page="history">History</a></li>
                <li><a href="https://testnet.hub.intuition.systems/" target="_blank" class="faucet-link">Claim Faucet</a></li>
            </ul>
        </div>
        <div class="user-section">
            Connected: <span class="wallet-address-display">Not Connected</span>
            <button class="connect-disconnect-btn">Connect Wallet</button>
        </div>
    </div>

    <div class="main-content">
        <div class="mobile-wallet-container">
            <span class="wallet-address-display">Not Connected</span>
            <button class="connect-disconnect-btn">Connect Wallet</button>
        </div>
        <div id="dashboard-page" class="content-section active">
            <h2>Dashboard</h2>
            <div class="dashboard-container">
                <div class="dashboard-description">
                    <p>This decentralized application allows anyone to send small tips to a recipient's wallet address. It's a simple, effective tool to encourage community engagement and reward contributors directly on the blockchain.</p>
                </div>
                <div class="stat-card">
                    <div id="total-received" class="stat-value">0.00</div>
                    <div class="stat-label">Total Tips Received (tTRUST)</div>
                </div>
                <div class="stat-card">
                    <div id="tips-received-count-card" class="stat-value">0</div>
                    <div class="stat-label">Tips Received (Count)</div>
                </div>
                <div class="stat-card">
                    <div id="total-sent" class="stat-value">0</div>
                    <div class="stat-label">Total Tips Sent</div>
                </div>
            </div>
            <div class="withdraw-container">
                <button id="withdrawButton" class="withdraw-button" disabled>Withdraw All Tips</button>
                <div id="dashboard-status" style="margin-top: 15px; font-size: 14px;"></div>
            </div>
        </div>

        <div id="tip-page" class="content-section">
            <h2>Send a Tip</h2>
            <div class="form-group">
                <input type="text" id="recipientAddress" placeholder="Recipient's wallet address" />
                
                <!-- New searchable token dropdown -->
                <div class="dropdown-container" id="token-dropdown">
                    <button class="dropdown-button" id="dropdown-button">
                        <span id="selected-token-display">tTRUST (Native)</span>
                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div class="dropdown-list-container" id="token-list-container">
                        <input type="text" id="token-search" class="token-search" placeholder="Search tokens or paste contract address...">
                        <div id="search-result-item" class="search-result-item">
                            <span id="search-result-name"></span>
                            <button class="add-btn">Add</button>
                        </div>
                        <div class="dropdown-list" id="token-list">
                            <!-- Native token, always first -->
                            <div class="dropdown-list-item selected" data-value="0x0000000000000000000000000000000000000000" data-name="tTRUST">tTRUST (Native)</div>
                        </div>
                    </div>
                </div>

                <input type="number" id="tipAmount" placeholder="Amount to tip" min="0.001" step="0.001" />

                <!-- New description field -->
                <textarea id="tipDescription" placeholder="Add a description..."></textarea>

                <button id="tipButton" class="submit-btn" disabled>Send Tip</button>
                <div id="status"></div>
                <div id="self-tip-message" class="error-message" style="display:none;"></div>
            </div>
        </div>

        <div id="history-page" class="content-section">
            <h2>All Transactions</h2>
            
            <div id="all-history-status" style="font-size: 14px; margin-bottom: 10px;">Connect your wallet to see history.</div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Party</th>
                        <th>Description</th>
                        <th>Tx Hash</th>
                    </tr>
                </thead>
                <tbody id="all-history-table-body"></tbody>
            </table>
        </div>

        <div class="signature">
            Made with ♥ by <a href="https://x.com/Jrken_ny" target="_blank">Jrkenny</a>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div id="transaction-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 class="modal-title">Transaction Details</h3>
            <div class="modal-body">
                <p><strong>Type:</strong> <span id="modal-type"></span></p>
                <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                <p><strong>Party:</strong> <span id="modal-party-display"></span></p>
                <p><strong>Address:</strong> <span class="full-address" id="modal-party-address"></span></p>
                <p><strong>Description:</strong> <span id="modal-description"></span></p>
                <p><strong>Time:</strong> <span id="modal-time"></span></p>
                <p><strong>Tx Hash:</strong> <a href="#" target="_blank" id="modal-tx-hash-link"></a></p>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Smart Contract details
            const contractAddress = "0x880931ff3977deb7773bbc1f777c9e22d4df399e";
            // NOTE: The ABI has been updated to include a 'description' parameter to simulate the new feature.
            const contractABI = [
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_recipient",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "_description",
                            "type": "string"
                        }
                    ],
                    "name": "sendTip",
                    "outputs": [],
                    "stateMutability": "payable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "tipper",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "recipient",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "amount",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "internalType": "string",
                            "name": "description",
                            "type": "string"
                        }
                    ],
                    "name": "TipSent",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "recipient",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "internalType": "uint256",
                            "name": "amount",
                            "type": "uint256"
                        }
                    ],
                    "name": "TipsWithdrawn",
                    "type": "event"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "balances",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_recipient",
                            "type": "address"
                        },
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        }
                    ],
                    "name": "getTippableBalance",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_token",
                            "type": "address"
                        }
                    ],
                    "name": "withdrawTips",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ];

            const ERC20_ABI = [
                "function approve(address spender, uint256 amount) returns (bool)",
                "function decimals() view returns (uint8)",
                "function symbol() view returns (string)",
                "function transfer(address to, uint256 amount) returns (bool)",
                "function balanceOf(address account) view returns (uint256)",
                "function allowance(address owner, address spender) view returns (uint256)"
            ];

            // Ethers.js provider and signer variables
            let provider;
            let signer;
            let tipJarContract;
            let userAddress = null;

            // Network details for Intuition Testnet
            const INTUITION_NETWORK_DETAILS = {
                chainId: "0x350B", // Hexadecimal for 13579
                chainName: "Intuition Testnet",
                nativeCurrency: {
                    name: "tTRUST",
                    symbol: "tTRUST",
                    decimals: 18
                },
                rpcUrls: ["https://testnet.rpc.intuition.systems/http"],
                blockExplorerUrls: ["https://testnet.explorer.intuition.systems"]
            };

            // DOM element references
            const recipientInput = document.getElementById("recipientAddress");
            const amountInput = document.getElementById("tipAmount");
            const tipDescriptionInput = document.getElementById("tipDescription");
            const tipButton = document.getElementById("tipButton");
            const withdrawButton = document.getElementById("withdrawButton");
            const statusDiv = document.getElementById("status");
            const selfTipMessage = document.getElementById("self-tip-message");
            const dashboardStatusDiv = document.getElementById("dashboard-status");
            
            const allHistoryTableBody = document.getElementById("all-history-table-body");
            const allHistoryStatus = document.getElementById("all-history-status");

            const totalReceivedDisplay = document.getElementById("total-received");
            const tipsReceivedCountDisplay = document.getElementById("tips-received-count-card");
            const totalSentDisplay = document.getElementById("total-sent");

            const navLinks = document.querySelectorAll(".nav-menu a[data-page]");
            const contentSections = document.querySelectorAll(".content-section");
            const menuButton = document.getElementById("menu-button");
            const sidebar = document.getElementById("sidebar");
            const body = document.body;

            const walletDisplays = document.querySelectorAll(".wallet-address-display");
            const connectDisconnectBtns = document.querySelectorAll(".connect-disconnect-btn");
            
            // New dropdown DOM elements
            const tokenDropdown = document.getElementById("token-dropdown");
            const dropdownButton = document.getElementById("dropdown-button");
            const tokenListContainer = document.getElementById("token-list-container");
            const tokenList = document.getElementById("token-list");
            const tokenSearch = document.getElementById("token-search");
            const selectedTokenDisplay = document.getElementById("selected-token-display");

            // Elements for dynamic search result
            const searchResultItem = document.getElementById("search-result-item");
            const searchResultName = document.getElementById("search-result-name");
            const addTokenButton = searchResultItem.querySelector('.add-btn');
            
            // Modal DOM elements
            const modal = document.getElementById("transaction-details-modal");
            const modalCloseBtn = modal.querySelector(".close-btn");
            const modalType = document.getElementById("modal-type");
            const modalAmount = document.getElementById("modal-amount");
            const modalPartyDisplay = document.getElementById("modal-party-display");
            const modalPartyAddress = document.getElementById("modal-party-address");
            const modalDescription = document.getElementById("modal-description");
            const modalTime = document.getElementById("modal-time");
            const modalTxHashLink = document.getElementById("modal-tx-hash-link");


            let selectedTokenAddress = "0x0000000000000000000000000000000000000000";
            const CUSTOM_TOKENS_STORAGE_KEY = 'customTokens';
            const PAGE_STORAGE_KEY = 'lastPage'; // New key for storing the last page
            
            // A central array to keep track of tokens, including the native one
            let allAvailableTokens = [{ address: "0x0000000000000000000000000000000000000000", symbol: "tTRUST", native: true }];

            // Global array to store fetched transactions
            let allTransactions = [];

            // --- UI Logic ---
            // Function to handle page navigation
            function showPage(pageId) {
                // Save the current page to local storage
                localStorage.setItem(PAGE_STORAGE_KEY, pageId);

                contentSections.forEach(s => s.classList.remove("active"));
                document.getElementById(pageId).classList.add("active");
                
                navLinks.forEach(l => l.classList.remove("active"));
                const activeLink = document.querySelector(`.nav-menu a[data-page="${pageId.replace('-page', '')}"]`);
                if (activeLink) {
                    activeLink.classList.add("active");
                }

                if (window.innerWidth <= 768) {
                    body.classList.remove("menu-open");
                }
            }
            
            // Event listener for mobile menu button
            menuButton.addEventListener("click", () => {
                body.classList.toggle("menu-open");
            });

            // Event listeners for navigation links
            navLinks.forEach(link => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    showPage(`${page}-page`);
                });
            });
            
            // Event listeners for connect/disconnect buttons
            connectDisconnectBtns.forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (userAddress) {
                        disconnectWallet();
                    } else {
                        connectWallet();
                    }
                };
            });
            
            // Event listener for transaction history table to open modal
            allHistoryTableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.index) {
                    const index = parseInt(row.dataset.index);
                    if (allTransactions[index]) {
                        showTransactionDetails(allTransactions[index]);
                    }
                }
            });

            // Event listener for closing the modal
            modalCloseBtn.addEventListener('click', () => {
                modal.classList.remove('is-visible');
            });
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('is-visible');
                }
            });

            function showTransactionDetails(tx) {
                modalType.textContent = tx.type;
                modalAmount.textContent = `${tx.amount} ${tx.tokenSymbol}`;
                modalPartyDisplay.textContent = tx.partyDisplay;
                modalPartyAddress.textContent = tx.partyAddress;
                modalDescription.textContent = tx.description || "No description provided.";
                modalTime.textContent = new Date(tx.time * 1000).toLocaleString();
                modalTxHashLink.textContent = `${tx.txHash.substring(0, 6)}...${tx.txHash.substring(62)}`;
                modalTxHashLink.href = tx.explorerUrl;
                
                modal.classList.add('is-visible');
            }
            
            // Dropdown & Token Logic
            const loadCustomTokens = () => {
                const storedTokens = JSON.parse(localStorage.getItem(CUSTOM_TOKENS_STORAGE_KEY) || '[]');
                allAvailableTokens = [...allAvailableTokens.filter(t => t.native), ...storedTokens];
                renderTokenList();
            };

            const saveCustomTokens = (tokens) => {
                localStorage.setItem(CUSTOM_TOKENS_STORAGE_KEY, JSON.stringify(tokens));
            };

            const renderTokenList = () => {
                tokenList.innerHTML = ""; // Clear the list
                allAvailableTokens.forEach(token => {
                    const newListItem = document.createElement("div");
                    newListItem.classList.add("dropdown-list-item");
                    newListItem.setAttribute("data-value", token.address);
                    newListItem.setAttribute("data-name", token.symbol);
                    newListItem.textContent = token.symbol + (token.native ? ' (Native)' : '');
                    tokenList.appendChild(newListItem);
                });
            };

            dropdownButton.addEventListener("click", (e) => {
                e.stopPropagation();
                tokenListContainer.classList.toggle("open");
                if (tokenListContainer.classList.contains("open")) {
                    tokenSearch.focus();
                }
            });

            // Search functionality, now with contract address lookup
            tokenSearch.addEventListener("input", async (e) => {
                const searchValue = e.target.value.trim();
                const listItems = tokenList.querySelectorAll(".dropdown-list-item");
                searchResultItem.classList.remove('show');
                
                // Filter existing list items
                listItems.forEach(item => {
                    const text = item.getAttribute('data-name').toLowerCase();
                    if (text.includes(searchValue.toLowerCase())) {
                        item.style.display = "flex";
                    } else {
                        item.style.display = "none";
                    }
                });
                
                // If input is a valid contract address, try to fetch its details
                if (ethers.utils.isAddress(searchValue)) {
                    // Check if token is already in the list
                    const existingItem = allAvailableTokens.some(t => t.address.toLowerCase() === searchValue.toLowerCase());
                    if (existingItem) {
                        return;
                    }
                    
                    try {
                        const tokenContract = new ethers.Contract(searchValue, ERC20_ABI, provider);
                        const tokenSymbol = await tokenContract.symbol();
                        
                        // Display the search result with an "Add" button
                        searchResultName.textContent = tokenSymbol;
                        searchResultItem.classList.add('show');
                        addTokenButton.setAttribute('data-address', searchValue);
                        addTokenButton.setAttribute('data-symbol', tokenSymbol);
                    } catch (error) {
                        console.error("Error fetching token:", error);
                        searchResultItem.classList.remove('show');
                    }
                }
            });

            // Handle token selection from the main list
            tokenList.addEventListener("click", (e) => {
                const clickedItem = e.target.closest(".dropdown-list-item");
                if (clickedItem) {
                    const address = clickedItem.getAttribute("data-value");
                    const name = clickedItem.getAttribute("data-name");
                    selectToken(address, name);
                }
            });

            const selectToken = (address, name) => {
                selectedTokenAddress = address;
                selectedTokenDisplay.textContent = name;
                
                const allItems = tokenList.querySelectorAll(".dropdown-list-item");
                allItems.forEach(item => item.classList.remove("selected"));
                
                const selectedItem = tokenList.querySelector(`[data-value="${address.toLowerCase()}"]`);
                if (selectedItem) {
                    selectedItem.classList.add("selected");
                }
                
                tokenListContainer.classList.remove("open");
            };
            
            // Handle clicking the "Add" button on the search result
            addTokenButton.addEventListener("click", (e) => {
                e.stopPropagation();
                const tokenAddress = addTokenButton.getAttribute('data-address');
                const tokenSymbol = addTokenButton.getAttribute('data-symbol');
                
                const storedTokens = JSON.parse(localStorage.getItem(CUSTOM_TOKENS_STORAGE_KEY) || '[]');
                const isNew = !storedTokens.some(t => t.address.toLowerCase() === tokenAddress.toLowerCase());
                
                if (isNew) {
                    storedTokens.push({ address: tokenAddress, symbol: tokenSymbol });
                    saveCustomTokens(storedTokens);
                }
                
                // Now, re-render the list from the source of truth and select the new token
                loadCustomTokens();
                selectToken(tokenAddress, tokenSymbol);

                // Hide search result and clear input
                searchResultItem.classList.remove('show');
                tokenSearch.value = "";
            });
            
            document.addEventListener("click", (e) => {
                if (!tokenDropdown.contains(e.target) && !menuButton.contains(e.target)) {
                    tokenListContainer.classList.remove("open");
                }
            });
            
            // --- Wallet and Ethers.js Logic ---
            // Initializes the ethers.js provider and contract instances
            function initializeContract() {
                if (typeof window.ethereum === 'undefined') {
                    walletDisplays.forEach(el => el.innerText = "MetaMask not found.");
                    return false;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                tipJarContract = new ethers.Contract(contractAddress, contractABI, signer);
                return true;
            }
            
            // Checks if a wallet is already connected on page load
            async function checkIfWalletIsConnected() {
                if (typeof window.ethereum !== 'undefined' && window.ethereum.isConnected()) {
                    try {
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            userAddress = accounts[0];
                            walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                            connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                            fetchDataAndHistory();
                            setupEventListeners();
                        } else {
                            userAddress = null;
                            walletDisplays.forEach(el => el.innerText = "Not Connected");
                            connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                            clearDashboardData();
                            clearHistory();
                            setupEventListeners();
                        }
                    } catch (error) {
                        console.error("Error checking for connected wallet:", error);
                        userAddress = null;
                        walletDisplays.forEach(el => el.innerText = "Not Connected");
                        connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                        clearDashboardData();
                        clearHistory();
                    }
                } else {
                    userAddress = null;
                    walletDisplays.forEach(el => el.innerText = "Not Connected");
                    connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                    clearDashboardData();
                    clearHistory();
                }
            }

            // Connects the user's wallet to the Dapp
            async function connectWallet() {
                try {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== INTUITION_NETWORK_DETAILS.chainId) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [INTUITION_NETWORK_DETAILS],
                            });
                        } catch (addError) {
                            statusDiv.textContent = "Failed to add the network. Please add it manually.";
                            return;
                        }
                    }
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                    connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                    fetchDataAndHistory();
                } catch (error) {
                    console.error("User denied account access or other error:", error);
                    statusDiv.textContent = "Connection failed. Please try again.";
                }
            }

            // Disconnects the user's wallet from the Dapp
            async function disconnectWallet() {
                userAddress = null;
                walletDisplays.forEach(el => el.innerText = "Not Connected");
                connectDisconnectBtns.forEach(btn => btn.innerText = "Connect Wallet");
                clearDashboardData();
                clearHistory();
            }

            // Fetches dashboard data and transaction history
            async function fetchDataAndHistory() {
                if (!userAddress || !tipJarContract) return;

                // Fetch total tips received (only for native token)
                try {
                    const balance = await tipJarContract.getTippableBalance(userAddress, "0x0000000000000000000000000000000000000000");
                    const formattedBalance = ethers.utils.formatEther(balance);
                    totalReceivedDisplay.textContent = parseFloat(formattedBalance).toFixed(2);
                } catch (error) {
                    console.error("Error fetching tippable balance:", error);
                }
                
                // Fetch tip counts
                let tipsReceivedCount = 0;
                let totalSentCount = 0;

                try {
                    const tipSentFilter = tipJarContract.filters.TipSent();
                    const logs = await provider.getLogs({
                        address: tipJarContract.address,
                        topics: tipSentFilter.topics,
                        fromBlock: 0
                    });

                    for (const log of logs) {
                        const parsedLog = tipJarContract.interface.parseLog(log);
                        if (parsedLog.args.recipient.toLowerCase() === userAddress.toLowerCase()) {
                            tipsReceivedCount++;
                        }
                        if (parsedLog.args.tipper.toLowerCase() === userAddress.toLowerCase()) {
                            totalSentCount++;
                        }
                    }

                    tipsReceivedCountDisplay.textContent = tipsReceivedCount;
                    totalSentDisplay.textContent = totalSentCount;
                } catch (error) {
                    console.error("Error fetching tips counts:", error);
                }
                
                // Fetch and display all transaction history
                await fetchAllHistory();
                
                // Enable/disable withdraw button based on native token balance
                const balance = await tipJarContract.getTippableBalance(userAddress, "0x0000000000000000000000000000000000000000");
                if (balance.gt(0)) {
                    withdrawButton.disabled = false;
                } else {
                    withdrawButton.disabled = true;
                }
            }
            
            async function fetchAllHistory() {
                allHistoryStatus.textContent = "Fetching all transactions...";
                allHistoryTableBody.innerHTML = "";
                
                if (!userAddress) {
                    allHistoryStatus.textContent = "Connect your wallet to see history.";
                    return;
                }

                allTransactions = []; // Reset global transactions array

                try {
                    // Optimized filters for better performance and reliability
                    const sentToUserFilter = tipJarContract.filters.TipSent(null, userAddress, null);
                    const sentByUserFilter = tipJarContract.filters.TipSent(userAddress, null, null);
                    const withdrawnByUserFilter = tipJarContract.filters.TipsWithdrawn(userAddress, null, null);

                    const [receivedLogs, sentLogs, withdrawnLogs] = await Promise.all([
                        provider.getLogs({ address: contractAddress, topics: sentToUserFilter.topics, fromBlock: 0 }),
                        provider.getLogs({ address: contractAddress, topics: sentByUserFilter.topics, fromBlock: 0 }),
                        provider.getLogs({ address: contractAddress, topics: withdrawnByUserFilter.topics, fromBlock: 0 })
                    ]);

                    for (const log of receivedLogs) {
                        allTransactions.push({ type: 'Received', log });
                    }
                    for (const log of sentLogs) {
                        allTransactions.push({ type: 'Sent', log });
                    }
                    for (const log of withdrawnLogs) {
                        allTransactions.push({ type: 'Withdrawn', log });
                    }
                    
                    if (allTransactions.length === 0) {
                        allHistoryStatus.textContent = "No transactions found.";
                        return;
                    }
                    
                    allHistoryStatus.textContent = "";

                    // Sort transactions by block number
                    allTransactions.sort((a, b) => a.log.blockNumber - b.log.blockNumber);

                    for (let i = 0; i < allTransactions.length; i++) {
                        const event = allTransactions[i];
                        const parsedLog = tipJarContract.interface.parseLog(event.log);
                        const txHash = event.log.transactionHash;
                        const explorerUrl = `${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/tx/${txHash}`;
                        
                        const newRow = document.createElement("tr");
                        newRow.setAttribute('data-index', i); // Store index for modal lookup

                        let amount, partyAddress, partyDisplay, description;

                        const typeCell = document.createElement("td");
                        typeCell.textContent = event.type;
                        newRow.appendChild(typeCell);
                        
                        const amountCell = document.createElement("td");
                        const partyCell = document.createElement("td");
                        const descriptionCell = document.createElement("td");
                        
                        let tokenAddress, tokenSymbol;
                        
                        if (parsedLog.args.token) {
                            tokenAddress = parsedLog.args.token;
                        } else if (event.log.topics.length > 2) {
                             // Fallback for cases where token is not in args but is in indexed topics
                            try {
                                const decoded = ethers.utils.defaultAbiCoder.decode(['address'], event.log.topics[2]);
                                tokenAddress = decoded[0];
                            } catch (e) {
                                tokenAddress = "0x0000000000000000000000000000000000000000";
                            }
                        } else {
                            tokenAddress = "0x0000000000000000000000000000000000000000";
                        }

                        tokenSymbol = 'tTRUST';
                        if (tokenAddress !== "0x0000000000000000000000000000000000000000") {
                            try {
                                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
                                tokenSymbol = await tokenContract.symbol();
                            } catch (e) {
                                tokenSymbol = "Unknown ERC20";
                            }
                        }
                        
                        amount = ethers.utils.formatEther(parsedLog.args.amount);
                        amountCell.textContent = `${parseFloat(amount).toFixed(4)} ${tokenSymbol}`;
                        
                        description = parsedLog.args.description;
                        descriptionCell.textContent = description || "No description provided.";
                        descriptionCell.classList.add('description-cell');

                        if (event.type === 'Received') {
                            partyAddress = parsedLog.args.tipper;
                            partyDisplay = `${partyAddress.substring(0, 6)}...${partyAddress.substring(38)}`;
                            partyCell.innerHTML = `<a href="${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/address/${partyAddress}" target="_blank" class="party-address" data-address="${partyAddress}">${partyDisplay}</a>`;
                        } else if (event.type === 'Sent') {
                            partyAddress = parsedLog.args.recipient;
                            partyDisplay = `${partyAddress.substring(0, 6)}...${partyAddress.substring(38)}`;
                            partyCell.innerHTML = `<a href="${INTUITION_NETWORK_DETAILS.blockExplorerUrls[0]}/address/${partyAddress}" target="_blank" class="party-address" data-address="${partyAddress}">${partyDisplay}</a>`;
                        } else if (event.type === 'Withdrawn') {
                            partyAddress = userAddress;
                            partyDisplay = 'Self';
                            partyCell.textContent = '-';
                            descriptionCell.textContent = '-';
                        }
                        
                        newRow.appendChild(amountCell);
                        newRow.appendChild(partyCell);
                        newRow.appendChild(descriptionCell);

                        const txHashCell = document.createElement("td");
                        txHashCell.innerHTML = `<a href="${explorerUrl}" target="_blank" class="explorer-link">${txHash.substring(0, 6)}...${txHash.substring(62)}</a>`;
                        newRow.appendChild(txHashCell);
                        
                        allHistoryTableBody.appendChild(newRow);
                        
                        // Add full details to the transaction array for modal
                        const block = await provider.getBlock(event.log.blockNumber);
                        const timestamp = block.timestamp;
                        allTransactions[i] = {
                            ...allTransactions[i],
                            amount,
                            tokenSymbol,
                            description,
                            partyAddress,
                            partyDisplay,
                            explorerUrl,
                            txHash,
                            time: timestamp
                        };
                    }
                } catch (error) {
                    console.error("Error fetching all history:", error);
                    allHistoryStatus.textContent = "Error fetching history.";
                }
            }

            // Clears dashboard data
            function clearDashboardData() {
                totalReceivedDisplay.textContent = "0.00";
                tipsReceivedCountDisplay.textContent = "0";
                totalSentDisplay.textContent = "0";
                withdrawButton.disabled = true;
            }

            // Clears transaction history
            function clearHistory() {
                allHistoryTableBody.innerHTML = "";
                allHistoryStatus.textContent = "Connect your wallet to see history.";
            }

            // Setup button event listeners
            function setupEventListeners() {
                tipButton.disabled = !userAddress;
                tipButton.onclick = sendTip;
                withdrawButton.disabled = !userAddress;
                withdrawButton.onclick = withdrawTips;
            }

            // --- Core Transaction Functions ---
            // Handles sending a tip
            async function sendTip() {
                if (!tipJarContract || !userAddress) {
                    statusDiv.textContent = "Please connect your wallet first.";
                    return;
                }

                const recipient = recipientInput.value;
                const amount = amountInput.value;
                const description = tipDescriptionInput.value.trim(); // Now just get the trimmed value
                
                selfTipMessage.style.display = 'none';
                statusDiv.textContent = '';
                
                if (userAddress && recipient.toLowerCase() === userAddress.toLowerCase()) {
                    selfTipMessage.textContent = "You can't tip yourself, silly!";
                    selfTipMessage.style.display = 'block';
                    return;
                }

                if (!ethers.utils.isAddress(recipient)) {
                    statusDiv.textContent = "Invalid recipient address.";
                    return;
                }
                
                if (parseFloat(amount) <= 0) {
                    statusDiv.textContent = "Amount must be greater than zero.";
                    return;
                }

                statusDiv.textContent = "Preparing transaction...";
                try {
                    let tx;
                    if (selectedTokenAddress === "0x0000000000000000000000000000000000000000") {
                        tx = await tipJarContract.sendTip(recipient, "0x0000000000000000000000000000000000000000", description, {
                            value: ethers.utils.parseEther(amount)
                        });
                        statusDiv.textContent = "Transaction sent. Awaiting confirmation...";
                    } else { // Custom ERC20 token
                        const tokenAddress = selectedTokenAddress;
                        
                        const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                        const tokenDecimals = await tokenContract.decimals();
                        const amountWei = ethers.utils.parseUnits(amount, tokenDecimals);

                        // A full implementation would check allowance and call approve first.
                        // For this demo, we'll assume the contract is already approved or that it's a simple transfer
                        // that the contract handles directly.
                        statusDiv.textContent = "ERC20 tipping requires an approval transaction first, which is not fully implemented in this demo. Proceeding to send tip directly...";

                        tx = await tipJarContract.sendTip(recipient, tokenAddress, description, amountWei);
                    }
                    
                    statusDiv.textContent = "Transaction sent. Awaiting confirmation...";
                    await tx.wait();
                    statusDiv.textContent = "Tip sent successfully!";
                    recipientInput.value = "";
                    amountInput.value = "";
                    tipDescriptionInput.value = "";
                    
                    fetchDataAndHistory();
                } catch (error) {
                    console.error(error);
                    statusDiv.textContent = `Transaction failed: ${error.message}`;
                }
            }
            
            // Handles withdrawing tips
            async function withdrawTips() {
                if (!tipJarContract || !userAddress) {
                    dashboardStatusDiv.textContent = "Please connect your wallet first.";
                    return;
                }
                
                dashboardStatusDiv.textContent = "Preparing withdrawal transaction...";
                try {
                    // This function only withdraws native tokens (tTRUST)
                    const tx = await tipJarContract.withdrawTips("0x0000000000000000000000000000000000000000");
                    dashboardStatusDiv.textContent = "Transaction sent. Awaiting confirmation...";
                    await tx.wait();
                    dashboardStatusDiv.textContent = "Tips withdrawn successfully!";
                    fetchDataAndHistory();
                } catch (error) {
                    console.error(error);
                    dashboardStatusDiv.textContent = `Withdrawal failed: ${error.message}`;
                }
            }

            // --- Initialization ---
            const lastPage = localStorage.getItem(PAGE_STORAGE_KEY);
            if (lastPage) {
                showPage(lastPage);
            } else {
                showPage('dashboard-page');
            }

            if (initializeContract()) {
                checkIfWalletIsConnected();
                loadCustomTokens();
            }

            // Listen for Metamask account/chain changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        walletDisplays.forEach(el => el.innerText = userAddress.substring(0, 6) + "..." + userAddress.substring(38));
                        connectDisconnectBtns.forEach(btn => btn.innerText = "Disconnect");
                        fetchDataAndHistory();
                        setupEventListeners();
                    } else {
                        disconnectWallet();
                    }
                });

                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
            }
        });
    </script>
</body>
</html>
